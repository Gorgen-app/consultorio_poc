# =============================================================================
# GORGEN - Workflow de Teste de Restaura√ß√£o Semanal
# =============================================================================
# Este workflow executa o teste de restaura√ß√£o do backup aos domingos √†s 04:00
# 
# Hor√°rio: 07:00 UTC = 04:00 BRT (Bras√≠lia)
# Frequ√™ncia: Domingos
# =============================================================================

name: üîÑ Teste de Restaura√ß√£o Semanal

on:
  # Agendamento autom√°tico (cron em UTC)
  schedule:
    - cron: '0 7 * * 0'  # 07:00 UTC = 04:00 BRT, Domingos
  
  # Permite execu√ß√£o manual via interface do GitHub
  workflow_dispatch:
    inputs:
      backup_id:
        description: 'ID do backup espec√≠fico para testar (opcional)'
        required: false
        type: string

env:
  GORGEN_API_URL: ${{ secrets.GORGEN_API_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # =========================================================================
  # Job: Executar Teste de Restaura√ß√£o
  # =========================================================================
  restore-test:
    name: üîÑ Teste de Restaura√ß√£o
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    outputs:
      test_success: ${{ steps.restore-test.outputs.success }}
      test_duration: ${{ steps.restore-test.outputs.duration }}
      validations_passed: ${{ steps.restore-test.outputs.validations_passed }}
      validations_total: ${{ steps.restore-test.outputs.validations_total }}
    
    steps:
      - name: üîê Verificar configura√ß√£o
        run: |
          if [ -z "$GORGEN_API_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "‚ùå Vari√°veis de ambiente n√£o configuradas"
            exit 1
          fi
          echo "‚úÖ Configura√ß√£o v√°lida"
      
      - name: üè• Verificar sa√∫de do servi√ßo
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$GORGEN_API_URL/api/cron/health")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Servi√ßo n√£o est√° saud√°vel"
            exit 1
          fi
          echo "‚úÖ Servi√ßo saud√°vel"
      
      - name: üîÑ Executar teste de restaura√ß√£o
        id: restore-test
        run: |
          echo "Iniciando teste de restaura√ß√£o..."
          START_TIME=$(date +%s)
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            --max-time 3600 \
            "$GORGEN_API_URL/api/cron/restore-test")
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Teste falhou (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          SUCCESS=$(echo "$BODY" | jq -r '.success')
          
          # Extrair estat√≠sticas de valida√ß√£o
          PASSED=$(echo "$BODY" | jq -r '.results[0].details.summary.passedValidations // 0')
          TOTAL=$(echo "$BODY" | jq -r '.results[0].details.summary.totalValidations // 0')
          
          echo "validations_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "validations_total=$TOTAL" >> $GITHUB_OUTPUT
          
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Teste de restaura√ß√£o falhou"
            echo "$BODY" | jq '.'
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Teste de restaura√ß√£o conclu√≠do com sucesso"
          echo "$BODY" | jq '.'
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: üìù Registrar resultado
        if: always()
        run: |
          echo "=========================================="
          echo "üìä RESUMO DO TESTE DE RESTAURA√á√ÉO"
          echo "=========================================="
          echo "Data/Hora: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Dura√ß√£o: ${{ steps.restore-test.outputs.duration }}s"
          echo "Valida√ß√µes: ${{ steps.restore-test.outputs.validations_passed }}/${{ steps.restore-test.outputs.validations_total }}"
          echo "Sucesso: ${{ steps.restore-test.outputs.success }}"
          echo "=========================================="

  # =========================================================================
  # Job: Notificar Resultado
  # =========================================================================
  notify-result:
    name: üì£ Notificar Resultado
    runs-on: ubuntu-latest
    needs: restore-test
    if: always()
    
    steps:
      - name: üì£ Notificar Slack
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          if [ "${{ needs.restore-test.outputs.test_success }}" == "true" ]; then
            EMOJI="‚úÖ"
            COLOR="good"
            STATUS="Sucesso"
          else
            EMOJI="‚ùå"
            COLOR="danger"
            STATUS="Falha"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Teste de Restaura√ß√£o Gorgen - $STATUS\",
                \"fields\": [
                  {\"title\": \"Data\", \"value\": \"$(date -u '+%Y-%m-%d %H:%M UTC')\", \"short\": true},
                  {\"title\": \"Dura√ß√£o\", \"value\": \"${{ needs.restore-test.outputs.test_duration }}s\", \"short\": true},
                  {\"title\": \"Valida√ß√µes\", \"value\": \"${{ needs.restore-test.outputs.validations_passed }}/${{ needs.restore-test.outputs.validations_total }}\", \"short\": true}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true
      
      - name: üö® Criar issue em caso de falha
        if: needs.restore-test.outputs.test_success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Falha no Teste de Restaura√ß√£o - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Detalhes da Falha
            
            - **Data/Hora:** ${new Date().toISOString()}
            - **Valida√ß√µes Aprovadas:** ${{ needs.restore-test.outputs.validations_passed }}/${{ needs.restore-test.outputs.validations_total }}
            
            ## A√ß√£o Necess√°ria
            
            ‚ö†Ô∏è **CR√çTICO**: O teste de restaura√ß√£o falhou. Isso significa que os backups podem n√£o ser restaur√°veis.
            
            1. Verificar logs do workflow
            2. Executar teste manual de restaura√ß√£o
            3. Verificar integridade dos backups recentes
            
            ## Links
            
            - [Logs do Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['backup', 'critical', 'automated']
            });
