name: ðŸ›¡ï¸ Testes de RegressÃ£o

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '22'

jobs:
  regression-tests:
    name: ðŸ§ª Executar Testes de RegressÃ£o
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ðŸ“¦ Instalar dependÃªncias
        run: pnpm install --frozen-lockfile

      - name: ðŸ›¡ï¸ Executar Testes de RegressÃ£o
        run: pnpm vitest run server/regression.test.ts --reporter=verbose
        env:
          CI: true

      - name: ðŸ“Š Resumo dos Testes
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Testes de RegressÃ£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Os testes de regressÃ£o protegem as seguintes funcionalidades crÃ­ticas:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥ **ProntuÃ¡rio MÃ©dico**: Acesso, evoluÃ§Ãµes, histÃ³rico" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Busca de Pacientes**: Case-insensitive, sem acentos" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¾ **Sistema de Backup**: CriaÃ§Ã£o, restauraÃ§Ã£o, validaÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ **Integridade**: AutenticaÃ§Ã£o, multi-tenant, imutabilidade" >> $GITHUB_STEP_SUMMARY

  full-test-suite:
    name: ðŸ§ª Suite Completa de Testes
    runs-on: ubuntu-latest
    needs: regression-tests
    
    steps:
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Instalar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ðŸ“¦ Instalar dependÃªncias
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Executar Todos os Testes
        run: pnpm vitest run --reporter=verbose
        env:
          CI: true
        continue-on-error: true

      - name: ðŸ“Š Gerar RelatÃ³rio
        if: always()
        run: |
          echo "## ðŸ“Š RelatÃ³rio de Testes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Suite completa de testes executada." >> $GITHUB_STEP_SUMMARY
