# =============================================================================
# GORGEN - Workflow de Backup Di√°rio
# =============================================================================
# Este workflow executa o backup di√°rio do sistema Gorgen √†s 03:00 (Bras√≠lia)
# 
# Hor√°rio: 06:00 UTC = 03:00 BRT (Bras√≠lia)
# Frequ√™ncia: Todos os dias
# =============================================================================

name: üóÑÔ∏è Backup Di√°rio

on:
  # Agendamento autom√°tico (cron em UTC)
  schedule:
    - cron: '0 6 * * *'  # 06:00 UTC = 03:00 BRT
  
  # Permite execu√ß√£o manual via interface do GitHub
  workflow_dispatch:
    inputs:
      force_backup:
        description: 'For√ßar backup mesmo se j√° houver um recente'
        required: false
        default: 'false'
        type: boolean

# Vari√°veis de ambiente globais
env:
  GORGEN_API_URL: ${{ secrets.GORGEN_API_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # =========================================================================
  # Job 1: Executar Backup Di√°rio
  # =========================================================================
  daily-backup:
    name: üì¶ Executar Backup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      backup_success: ${{ steps.backup.outputs.success }}
      backup_duration: ${{ steps.backup.outputs.duration }}
      backup_details: ${{ steps.backup.outputs.details }}
    
    steps:
      # Passo 1: Verificar vari√°veis de ambiente
      - name: üîê Verificar configura√ß√£o
        id: check-config
        run: |
          echo "Verificando vari√°veis de ambiente..."
          
          if [ -z "$GORGEN_API_URL" ]; then
            echo "‚ùå GORGEN_API_URL n√£o configurado"
            exit 1
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET n√£o configurado"
            exit 1
          fi
          
          echo "‚úÖ Configura√ß√£o v√°lida"
          echo "üìç API URL: $GORGEN_API_URL"
      
      # Passo 2: Verificar sa√∫de do servi√ßo
      - name: üè• Verificar sa√∫de do servi√ßo
        id: health-check
        run: |
          echo "Verificando sa√∫de do servi√ßo de scheduler..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $CRON_SECRET" \
            "$GORGEN_API_URL/api/cron/health")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Servi√ßo n√£o est√° saud√°vel (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
          
          echo "‚úÖ Servi√ßo saud√°vel"
          echo "$BODY" | jq '.'
      
      # Passo 3: Executar backup
      - name: üóÑÔ∏è Executar backup di√°rio
        id: backup
        run: |
          echo "Iniciando backup di√°rio..."
          START_TIME=$(date +%s)
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$GORGEN_API_URL/api/cron/backup/daily")
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Backup falhou (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Verificar se o backup foi bem-sucedido
          SUCCESS=$(echo "$BODY" | jq -r '.success')
          
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Backup retornou erro"
            echo "$BODY" | jq '.'
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Backup conclu√≠do com sucesso"
          echo "$BODY" | jq '.'
          echo "success=true" >> $GITHUB_OUTPUT
      
      # Passo 4: Registrar resultado
      - name: üìù Registrar resultado
        if: always()
        run: |
          echo "=========================================="
          echo "üìä RESUMO DO BACKUP DI√ÅRIO"
          echo "=========================================="
          echo "Data/Hora: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Dura√ß√£o: ${{ steps.backup.outputs.duration }}s"
          echo "Sucesso: ${{ steps.backup.outputs.success }}"
          echo "=========================================="

  # =========================================================================
  # Job 2: Executar Limpeza de Backups Antigos
  # =========================================================================
  cleanup-old-backups:
    name: üßπ Limpeza de Backups
    runs-on: ubuntu-latest
    needs: daily-backup
    if: always() && needs.daily-backup.outputs.backup_success == 'true'
    timeout-minutes: 15
    
    steps:
      - name: üßπ Executar limpeza
        id: cleanup
        run: |
          echo "Iniciando limpeza de backups antigos..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$GORGEN_API_URL/api/cron/backup/cleanup")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ö†Ô∏è Limpeza falhou (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            exit 0  # N√£o falha o workflow por causa da limpeza
          fi
          
          echo "‚úÖ Limpeza conclu√≠da"
          echo "$BODY" | jq '.'

  # =========================================================================
  # Job 3: Notificar Resultado
  # =========================================================================
  notify-result:
    name: üì£ Notificar Resultado
    runs-on: ubuntu-latest
    needs: [daily-backup, cleanup-old-backups]
    if: always()
    
    steps:
      # Notifica√ß√£o via Slack (opcional)
      - name: üì£ Notificar Slack
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          if [ "${{ needs.daily-backup.outputs.backup_success }}" == "true" ]; then
            EMOJI="‚úÖ"
            COLOR="good"
            STATUS="Sucesso"
          else
            EMOJI="‚ùå"
            COLOR="danger"
            STATUS="Falha"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Backup Di√°rio Gorgen - $STATUS\",
                \"fields\": [
                  {\"title\": \"Data\", \"value\": \"$(date -u '+%Y-%m-%d %H:%M UTC')\", \"short\": true},
                  {\"title\": \"Dura√ß√£o\", \"value\": \"${{ needs.daily-backup.outputs.backup_duration }}s\", \"short\": true}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true
      
      # Criar issue em caso de falha
      - name: üö® Criar issue em caso de falha
        if: needs.daily-backup.outputs.backup_success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Falha no Backup Di√°rio - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Detalhes da Falha
            
            - **Data/Hora:** ${new Date().toISOString()}
            - **Workflow:** ${context.workflow}
            - **Run ID:** ${context.runId}
            
            ## A√ß√£o Necess√°ria
            
            1. Verificar logs do workflow
            2. Verificar status do servi√ßo Gorgen
            3. Executar backup manual se necess√°rio
            
            ## Links
            
            - [Logs do Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['backup', 'urgent', 'automated']
            });
