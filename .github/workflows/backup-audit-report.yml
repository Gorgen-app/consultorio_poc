# =============================================================================
# GORGEN - Workflow de Relat√≥rio de Auditoria Mensal
# =============================================================================
# Este workflow gera o relat√≥rio de auditoria de backups no 1¬∫ dia de cada m√™s
# 
# Hor√°rio: 09:00 UTC = 06:00 BRT (Bras√≠lia)
# Frequ√™ncia: Dia 1 de cada m√™s
# =============================================================================

name: üìä Relat√≥rio de Auditoria Mensal

on:
  # Agendamento autom√°tico (cron em UTC)
  schedule:
    - cron: '0 9 1 * *'  # 09:00 UTC = 06:00 BRT, Dia 1 do m√™s
  
  # Permite execu√ß√£o manual via interface do GitHub
  workflow_dispatch:
    inputs:
      month:
        description: 'M√™s do relat√≥rio (opcional, formato: YYYY-MM)'
        required: false
        type: string

env:
  GORGEN_API_URL: ${{ secrets.GORGEN_API_URL }}
  CRON_SECRET: ${{ secrets.CRON_SECRET }}
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # =========================================================================
  # Job: Gerar Relat√≥rio de Auditoria
  # =========================================================================
  audit-report:
    name: üìä Gerar Relat√≥rio
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      report_success: ${{ steps.audit.outputs.success }}
      total_backups: ${{ steps.audit.outputs.total_backups }}
      success_rate: ${{ steps.audit.outputs.success_rate }}
      compliance_status: ${{ steps.audit.outputs.compliance_status }}
    
    steps:
      - name: üîê Verificar configura√ß√£o
        run: |
          if [ -z "$GORGEN_API_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "‚ùå Vari√°veis de ambiente n√£o configuradas"
            exit 1
          fi
          echo "‚úÖ Configura√ß√£o v√°lida"
      
      - name: üìä Gerar relat√≥rio de auditoria
        id: audit
        run: |
          echo "Gerando relat√≥rio de auditoria mensal..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            "$GORGEN_API_URL/api/cron/audit-report")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Gera√ß√£o do relat√≥rio falhou (HTTP $HTTP_CODE)"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Extrair estat√≠sticas
          TOTAL=$(echo "$BODY" | jq -r '.results[0].details.totalBackups // 0')
          SUCCESS_RATE=$(echo "$BODY" | jq -r '.results[0].details.successRate // 0')
          
          # Verificar compliance
          DAILY_MET=$(echo "$BODY" | jq -r '.results[0].details.compliance.dailyBackupsMet // false')
          ENCRYPTION_MET=$(echo "$BODY" | jq -r '.results[0].details.compliance.encryptionCompliance // false')
          
          if [ "$DAILY_MET" == "true" ] && [ "$ENCRYPTION_MET" == "true" ]; then
            COMPLIANCE="‚úÖ Em conformidade"
          else
            COMPLIANCE="‚ö†Ô∏è N√£o conformidade detectada"
          fi
          
          echo "total_backups=$TOTAL" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "compliance_status=$COMPLIANCE" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Relat√≥rio gerado com sucesso"
          echo "$BODY" | jq '.'
      
      - name: üìù Registrar resultado
        if: always()
        run: |
          echo "=========================================="
          echo "üìä RESUMO DO RELAT√ìRIO DE AUDITORIA"
          echo "=========================================="
          echo "Per√≠odo: M√™s anterior"
          echo "Total de Backups: ${{ steps.audit.outputs.total_backups }}"
          echo "Taxa de Sucesso: ${{ steps.audit.outputs.success_rate }}%"
          echo "Compliance: ${{ steps.audit.outputs.compliance_status }}"
          echo "=========================================="

  # =========================================================================
  # Job: Notificar Resultado
  # =========================================================================
  notify-result:
    name: üì£ Notificar Resultado
    runs-on: ubuntu-latest
    needs: audit-report
    if: always()
    
    steps:
      - name: üì£ Notificar Slack
        if: env.SLACK_WEBHOOK_URL != ''
        run: |
          MONTH=$(date -d "last month" '+%B %Y')
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"#36a64f\",
                \"title\": \"üìä Relat√≥rio de Auditoria de Backups - $MONTH\",
                \"fields\": [
                  {\"title\": \"Total de Backups\", \"value\": \"${{ needs.audit-report.outputs.total_backups }}\", \"short\": true},
                  {\"title\": \"Taxa de Sucesso\", \"value\": \"${{ needs.audit-report.outputs.success_rate }}%\", \"short\": true},
                  {\"title\": \"Compliance\", \"value\": \"${{ needs.audit-report.outputs.compliance_status }}\", \"short\": false}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL" || true
