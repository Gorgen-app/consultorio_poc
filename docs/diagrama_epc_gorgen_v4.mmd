%%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '14px', 'primaryColor': '#e3f2fd', 'primaryTextColor': '#1565c0', 'primaryBorderColor': '#1976d2', 'lineColor': '#616161', 'secondaryColor': '#e8f5e9', 'tertiaryColor': '#fff8e1'}}}%%
flowchart TB
    %% ========================================
    %% TÃTULO
    %% ========================================
    subgraph HEADER[" "]
        direction LR
        TITLE["ğŸ¥ <b>GORGEN - Sistema de GestÃ£o em SaÃºde</b><br/>Diagrama EPC - Event-driven Process Chain v4"]
    end

    %% ========================================
    %% FLUXO PRINCIPAL - JORNADA DO PACIENTE
    %% ========================================
    
    %% ENTRADA
    START([ğŸ”µ Paciente entra<br/>em contato])
    
    %% VERIFICAÃ‡ÃƒO INICIAL
    subgraph VERIF["1ï¸âƒ£ VERIFICAÃ‡ÃƒO INICIAL"]
        V1{Paciente jÃ¡<br/>cadastrado?}
        V2{Cadastrado<br/>neste tenant?}
    end
    
    %% CADASTRO (paciente novo)
    subgraph CADASTRO["2ï¸âƒ£ CADASTRO"]
        C1[/ğŸ“ Cadastrar<br/>Paciente/]
        C2([âœ… Paciente<br/>registrado])
    end
    
    %% CROSS-TENANT (paciente de outra clÃ­nica)
    subgraph SHARE["3ï¸âƒ£ CROSS-TENANT"]
        S1[/ğŸ“© Criar SolicitaÃ§Ã£o<br/>de Acesso/]
        S2([ğŸŸ¡ SolicitaÃ§Ã£o<br/>pendente])
        S3[/ğŸ“§ Notificar<br/>ClÃ­nica Origem/]
        S4{Paciente<br/>autoriza?}
        S5[/âœ… Aprovar com<br/>Consentimento LGPD/]
        S6([ğŸ”“ Acesso<br/>autorizado])
        S7[/ğŸ“¥ Importar Dados<br/>do Paciente/]
        S8([âœ… Dados<br/>disponÃ­veis])
        S9([âŒ Acesso<br/>negado])
        S10[/ğŸ“ Registrar<br/>Log Auditoria/]
    end
    
    %% FLUXO ALTERNATIVO - NEGATIVA DE COMPARTILHAMENTO
    subgraph NEGATIVA["3ï¸âƒ£.B ALTERNATIVAS APÃ“S NEGATIVA"]
        N1{Paciente deseja<br/>prosseguir?}
        N2[/ğŸ“ Cadastrar como<br/>Novo Paciente/]
        N3([âœ… Paciente<br/>cadastrado<br/>sem histÃ³rico])
        N4{Paciente traz<br/>documentos?}
        N5[/ğŸ“¤ Upload Manual<br/>de Documentos/]
        N6[/ğŸ¤– Extrair<br/>OCR/IA/]
        N7([ğŸ“‹ Documentos<br/>anexados])
        N8([ğŸš« Atendimento<br/>cancelado])
    end
    
    %% AGENDAMENTO
    subgraph AGENDA["4ï¸âƒ£ AGENDAMENTO"]
        A1[/ğŸ“… Verificar<br/>Disponibilidade/]
        A2{HorÃ¡rio<br/>livre?}
        A3[/âœ… Agendar<br/>Consulta/]
        A4([ğŸ“† Consulta<br/>agendada])
        A5[/ğŸ“§ Enviar<br/>ConfirmaÃ§Ã£o/]
    end
    
    %% ATENDIMENTO
    subgraph ATEND["5ï¸âƒ£ ATENDIMENTO"]
        T1([ğŸ”µ Paciente<br/>chega])
        T2[/ğŸ“‹ Iniciar<br/>Atendimento/]
        T3[/ğŸ“ Registrar<br/>EvoluÃ§Ã£o SOAP/]
        T4{Exames?}
        T5[/ğŸ“„ Solicitar<br/>Exames/]
        T6{Receita?}
        T7[/ğŸ’Š Emitir<br/>PrescriÃ§Ã£o/]
        T8[/âœ… Finalizar<br/>Atendimento/]
        T9([ğŸŸ¢ Atendimento<br/>concluÃ­do])
    end
    
    %% PRONTUÃRIO
    subgraph PRONT["6ï¸âƒ£ PRONTUÃRIO"]
        P1[/ğŸ“ Atualizar<br/>ProntuÃ¡rio/]
        P2[/ğŸ“¤ Upload<br/>Documentos/]
        P3[/ğŸ¤– Extrair<br/>OCR/IA/]
        P4([ğŸ“Š Dados<br/>indexados])
    end
    
    %% FATURAMENTO
    subgraph FATUR["7ï¸âƒ£ FATURAMENTO"]
        F1[/ğŸ’µ Calcular<br/>HonorÃ¡rios/]
        F2[/ğŸ“¨ Enviar<br/>Fatura/]
        F3{Pagamento<br/>recebido?}
        F4[/âœ… Registrar<br/>Pagamento/]
        F5([ğŸ’° Faturamento<br/>concluÃ­do])
    end
    
    %% AUDITORIA
    subgraph AUDIT["8ï¸âƒ£ AUDITORIA"]
        AU1[/ğŸ“ Registrar<br/>AÃ§Ãµes/]
        AU2([ğŸ”’ Conformidade<br/>LGPD])
    end

    %% ========================================
    %% CONEXÃ•ES DO FLUXO PRINCIPAL
    %% ========================================
    
    %% Entrada e verificaÃ§Ã£o
    START --> V1
    
    %% Paciente NÃƒO cadastrado em lugar nenhum â†’ Cadastro novo
    V1 -->|NÃ£o| C1 --> C2 --> A1
    
    %% Paciente JÃ cadastrado â†’ verificar onde
    V1 -->|Sim| V2
    
    %% Cadastrado NESTE tenant â†’ direto para agendamento
    V2 -->|Sim| A1
    
    %% Cadastrado em OUTRO tenant â†’ Cross-Tenant
    V2 -->|NÃ£o, em<br/>outro tenant| S1
    
    %% Fluxo Cross-Tenant - AprovaÃ§Ã£o
    S1 --> S2 --> S3 --> S4
    S4 -->|Sim| S5 --> S6 --> S10 --> S7 --> S8
    
    %% ApÃ³s autorizaÃ§Ã£o cross-tenant â†’ Agendamento
    S8 --> A1
    
    %% ========================================
    %% FLUXO DE NEGATIVA
    %% ========================================
    S4 -->|NÃ£o| S9 --> N1
    
    %% Paciente deseja prosseguir mesmo sem histÃ³rico?
    N1 -->|Sim| N2 --> N3 --> N4
    N1 -->|NÃ£o| N8
    
    %% Paciente traz documentos fÃ­sicos/digitais?
    N4 -->|Sim| N5 --> N6 --> N7 --> A1
    N4 -->|NÃ£o| A1
    
    %% ========================================
    %% FLUXO DE AGENDAMENTO
    %% ========================================
    A1 --> A2
    A2 -->|Sim| A3 --> A4 --> A5
    A2 -->|NÃ£o| A1
    
    %% Dia da consulta
    A5 -.->|Dia da consulta| T1
    
    %% ========================================
    %% FLUXO DE ATENDIMENTO
    %% ========================================
    T1 --> T2 --> T3 --> T4
    T4 -->|Sim| T5 --> T6
    T4 -->|NÃ£o| T6
    T6 -->|Sim| T7 --> T8
    T6 -->|NÃ£o| T8
    T8 --> T9
    
    %% ========================================
    %% PÃ“S-ATENDIMENTO
    %% ========================================
    T9 --> P1
    P1 --> P2
    P2 --> P3 --> P4
    
    T9 --> F1
    F1 --> F2 --> F3
    F3 -->|Sim| F4 --> F5
    F3 -->|NÃ£o| F2
    
    %% ========================================
    %% AUDITORIA
    %% ========================================
    T9 --> AU1 --> AU2
    S10 --> AU2
    N8 --> AU1

    %% ========================================
    %% LEGENDA
    %% ========================================
    subgraph LEG["ğŸ“– LEGENDA"]
        direction LR
        L1([ğŸ”µ Evento<br/>Inicial])
        L2([ğŸŸ¢ Evento<br/>Final])
        L3([ğŸŸ¡ Evento<br/>Pendente])
        L4([âŒ Evento<br/>Negado])
        L5([ğŸš« Cancelado])
        L6[/ğŸ“ FunÃ§Ã£o/<br/>Atividade/]
        L7{DecisÃ£o/<br/>Gateway}
    end

    %% ========================================
    %% ESTILOS
    %% ========================================
    classDef eventoInicial fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    classDef eventoFinal fill:#e8f5e9,stroke:#388e3c,stroke-width:2px,color:#1b5e20
    classDef eventoPendente fill:#fff8e1,stroke:#f9a825,stroke-width:2px,color:#e65100
    classDef eventoErro fill:#ffebee,stroke:#d32f2f,stroke-width:2px,color:#b71c1c
    classDef eventoCancelado fill:#fce4ec,stroke:#c2185b,stroke-width:2px,color:#880e4f
    classDef funcao fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#e65100
    classDef decisao fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#4a148c
    
    class START,T1 eventoInicial
    class C2,S6,S8,N3,N7,A4,T9,P4,F5,AU2 eventoFinal
    class S2 eventoPendente
    class S9 eventoErro
    class N8 eventoCancelado
    class C1,A1,A3,A5,T2,T3,T5,T7,T8,P1,P2,P3,F1,F2,F4,S1,S3,S5,S7,S10,N2,N5,N6,AU1 funcao
    class V1,V2,A2,T4,T6,F3,S4,N1,N4 decisao
